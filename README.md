# Safeshelter Map

災害時の通信不安定な環境でも、最低限の避難情報を閲覧できることを目的としたWebアプリケーションです。

自治体が公開している防災関連オープンデータ（CSV）を活用し、避難所・避難場所・帰宅困難者支援施設などの情報を検索・表示します。

本プロジェクトは、将来的に個人・各自治体や地域コミュニティが独自に展開・改修できることを前提とした、社会インフラ志向のオープンソースプロジェクトを目指しています。

---

## デモ

https://ayakaya.pythonanywhere.com/places/

---

## 背景

Python学習のアウトプットとして、CSVデータを利用した実用的なWebアプリケーションを制作したいと考えたことが本プロジェクトの出発点です。

当初は「オンラインで利用できる避難所検索アプリ」として設計を開始しましたが、開発途中で以下の疑問が生まれました。

- 災害時こそ通信が不安定になるのではないか？
- オフライン時でも動くべきではないのか？

この疑問がきっかけに、PWA化およびService Worker導入によるオフライン対応を実装しました。

---

## 現在の仕様

### オンライン時

- キーワード検索
- カテゴリ絞り込み
- CSVデータの更新による最新情報反映

### 物理オフライン時

- 一覧ページ表示を保証
- カテゴリ絞り込み（キーワード未入力時）はオフライン対応
- キーワード検索は不可（検索ロジックがサーバー依存のため）

---

## キャッシュ戦略

Service Workerのキャッシュ戦略は以下の方針で設計しています。
- /places/（一覧ページ）は常にキャッシュ対象
- category + 空qのみをカテゴリ専用検索としてキャッシュ
- キーワード検索はキャッシュ対象外（検索結果の張り付き防止）
- キャッシュキーをpathname + searchに統一
これにより、
- 最低限の閲覧保証
- 誤作動や検索結果の固定化防止
- オンライン／オフライン挙動の明確化
を両立しています。

---

## MVP要件

### 開発開始時の要件

- Django＋SQLite構成
- CSVデータの取り込み
- キーワード検索
- カテゴリ絞り込み
- Web公開

### 途中追加要件

- オフライン対応
- PWA対応
- Service Worker導入
- 一覧ページのオフライン保証

---

## 設計上の制約

検索処理はDjango＋SQLiteによるサーバーサイド実装となっているため、物理オフライン環境では新規検索を実行することができません。

完全オフライン検索を実現するには、
- JSON API化
- IndexedDBによるデータ保持
- クライアントサイド検索実装
といったアーキテクチャ変更が必要となります。

本プロジェクトでは、MVP段階として「最低限の閲覧保証」を優先する設計としています。

---

## 技術構成

- Python 3.10
- Django 4.2
- SQLite
- HTML/CSS/JavaScript
- Service Worker(Cache API)
- PWA(manifest.json)
- PythonAnywhere(本番環境)

---

## 失敗と学び

### 要件定義の途中変更

開発途中で「完全オフライン検索」を目標に追加しましたが、既存アーキテクチャでは対応困難であることを実体験しました。

要件変更は機能追加ではなく、構造再設計を伴うものであることを学びました。

---

### 本番環境とテスト環境の差

- DevTools Offlineと物理オフラインの挙動差
- HTTPキャッシュとService Workerキャッシュの違い
- ローカル環境とPythonAnywhere本番環境の差異

ローカルで動作することと、本番環境で安定動作することは別問題であることを実感しました。

---

## 今後の改善予定

- JSON APIエンドポイント実装
- IndexedDBによるデータ保持
- UI/UX改善
- CSV仕様の明文化
- 自治体別展開手順のドキュメント化

将来的には、個人・各自治体や地域コミュニティがフォークし、地域最適化された形で導入できる構造を目指します。

---

## 出典

本アプリは、船橋市オープンデータポータルで公開されている以下のオープンデータを加工・再構築して利用しています。

- 避難場所一覧
- 避難所(一時滞在可能)
- 帰宅困難者支援施設

出典：船橋市オープンデータポータル  
ライセンス：Creative Commons Attribution 4.0 International (CC BY 4.0)

---

## License

本プロジェクトは、公共性の高い利用を想定したオープンソースプロジェクトです。

将来的な拡張や自治体ごとの展開を前提とし、利用者間の知財トラブルを未然に防ぎ、安心して利用・改変・再配布できる環境を整えるため、特許条項を含む「Apache License 2.0」を採用しています。

詳細は`LICENSE`ファイルをご参照ください。

---

## 目指す姿

本プロジェクトは、特定の個人の所有物ではなく、各地域でフォークされ、実際の災害時に活用されるOSSとなることを理想としています。

技術習得のアウトプットに留まらず、社会的意義を持つプロジェクトとして継続的に改善していきます。

---